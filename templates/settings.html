{% extends "base.html" %}

{% block title %}System Settings - WhatsApp Internship System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cog me-2"></i>System Settings</h1>
    </div>
    
    <form method="POST" action="{{ url_for('update_settings') }}">
        <div class="row">
            <!-- Twilio SMS Settings -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-sms me-2"></i>SMS Settings (Twilio)</h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="testCommunication('sms')">
                            <i class="fas fa-paper-plane me-1"></i>Test SMS
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="twilio_account_sid" class="form-label">1. Account SID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="setting_twilio_account_sid" 
                                   value="{{ settings.sms|selectattr('key', 'equalto', 'twilio_account_sid')|map(attribute='value')|first or '' }}"
                                   placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                            <small class="text-muted">Find this on your Twilio Console homepage (starts with "AC")</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="twilio_auth_token" class="form-label">2. Auth Token <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" name="setting_twilio_auth_token" 
                                   value="{{ settings.sms|selectattr('key', 'equalto', 'twilio_auth_token')|map(attribute='value')|first or '' }}"
                                   placeholder="••••••••••••••••••••••••••••••••" required>
                            <small class="text-muted">Click "show" next to Auth Token on Twilio Console homepage</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="twilio_phone_number" class="form-label">3. Your Twilio Phone Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="setting_twilio_phone_number" 
                                   value="{{ settings.sms|selectattr('key', 'equalto', 'twilio_phone_number')|map(attribute='value')|first or '' }}"
                                   placeholder="+1234567890" required>
                            <small class="text-muted">Include country code (e.g., +1 for US). Find in Phone Numbers section.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="test_phone_number" class="form-label">4. Test Phone Number <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="setting_test_phone_number" 
                                   value="{{ settings.sms|selectattr('key', 'equalto', 'test_phone_number')|map(attribute='value')|first or '' }}"
                                   placeholder="+1234567890" required>
                            <small class="text-muted">Your phone number to receive test SMS (must be verified in Twilio for free accounts)</small>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Quick Setup:</strong>
                            <ol class="mb-0 mt-2">
                                <li><strong>Sign up:</strong> Go to <a href="https://www.twilio.com/try-twilio" target="_blank">twilio.com/try-twilio</a></li>
                                <li><strong>Get credentials:</strong> Copy Account SID and Auth Token from your Twilio Console home page</li>
                                <li><strong>Get phone number:</strong> Go to Phone Numbers → Manage → Buy a number (or use trial number)</li>
                                <li><strong>Test:</strong> Fill in the form above and click "Test SMS"</li>
                            </ol>
                            <div class="mt-2">
                                <small><strong>Note:</strong> Free accounts can only send to verified numbers. Add your test number in Twilio Console first.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Settings -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fab fa-whatsapp me-2"></i>WhatsApp Settings</h5>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="testCommunication('whatsapp')">
                            <i class="fas fa-paper-plane me-1"></i>Test WhatsApp
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="whatsapp_access_token" class="form-label">Access Token</label>
                            <input type="password" class="form-control" name="setting_whatsapp_access_token" 
                                   value="{{ settings.whatsapp|selectattr('key', 'equalto', 'whatsapp_access_token')|map(attribute='value')|first or '' }}"
                                   placeholder="••••••••••••••••••••••••••••••••">
                            <small class="text-muted">WhatsApp Business API Access Token</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="whatsapp_phone_number_id" class="form-label">Phone Number ID</label>
                            <input type="text" class="form-control" name="setting_whatsapp_phone_number_id" 
                                   value="{{ settings.whatsapp|selectattr('key', 'equalto', 'whatsapp_phone_number_id')|map(attribute='value')|first or '' }}"
                                   placeholder="123456789012345">
                            <small class="text-muted">WhatsApp Business Phone Number ID</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="whatsapp_verify_token" class="form-label">Webhook Verify Token</label>
                            <input type="text" class="form-control" name="setting_whatsapp_verify_token" 
                                   value="{{ settings.whatsapp|selectattr('key', 'equalto', 'whatsapp_verify_token')|map(attribute='value')|first or '' }}"
                                   placeholder="your_verify_token">
                            <small class="text-muted">Token for webhook verification</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="test_whatsapp_number" class="form-label">Test WhatsApp Number</label>
                            <input type="text" class="form-control" name="setting_test_whatsapp_number" 
                                   value="{{ settings.whatsapp|selectattr('key', 'equalto', 'test_whatsapp_number')|map(attribute='value')|first or '' }}"
                                   placeholder="+1234567890">
                            <small class="text-muted">WhatsApp number to send test messages to</small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Setup Instructions:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Set up WhatsApp Business API through Meta</li>
                                <li>Get Access Token from Facebook Developers</li>
                                <li>Configure webhook URL: <code>/webhook/whatsapp</code></li>
                                <li>Enter credentials and test the connection</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Email Settings -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>Email Settings</h5>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="testCommunication('email')">
                            <i class="fas fa-paper-plane me-1"></i>Test Email
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="smtp_server" class="form-label">SMTP Server</label>
                            <input type="text" class="form-control" name="setting_smtp_server" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'smtp_server')|map(attribute='value')|first or 'smtp.gmail.com' }}"
                                   placeholder="smtp.gmail.com">
                            <small class="text-muted">SMTP server hostname</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_port" class="form-label">SMTP Port</label>
                            <input type="number" class="form-control" name="setting_smtp_port" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'smtp_port')|map(attribute='value')|first or '587' }}"
                                   placeholder="587">
                            <small class="text-muted">Usually 587 for TLS or 465 for SSL</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_username" class="form-label">SMTP Username</label>
                            <input type="email" class="form-control" name="setting_smtp_username" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'smtp_username')|map(attribute='value')|first or '' }}"
                                   placeholder="your-email@gmail.com">
                            <small class="text-muted">Your email address</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="smtp_password" class="form-label">SMTP Password</label>
                            <input type="password" class="form-control" name="setting_smtp_password" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'smtp_password')|map(attribute='value')|first or '' }}"
                                   placeholder="••••••••••••••••">
                            <small class="text-muted">Your email password or app password</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="from_email" class="form-label">From Email</label>
                            <input type="email" class="form-control" name="setting_from_email" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'from_email')|map(attribute='value')|first or '' }}"
                                   placeholder="noreply@yourcompany.com">
                            <small class="text-muted">Email address to send from</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="test_email" class="form-label">Test Email</label>
                            <input type="email" class="form-control" name="setting_test_email" 
                                   value="{{ settings.email|selectattr('key', 'equalto', 'test_email')|map(attribute='value')|first or '' }}"
                                   placeholder="test@example.com">
                            <small class="text-muted">Email address to send test emails to</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- General Settings -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-sliders-h me-2"></i>General Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="system_name" class="form-label">System Name</label>
                            <input type="text" class="form-control" name="setting_system_name" 
                                   value="{{ settings.general|selectattr('key', 'equalto', 'system_name')|map(attribute='value')|first or 'WhatsApp Internship System' }}"
                                   placeholder="WhatsApp Internship System">
                            <small class="text-muted">Name displayed in notifications</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" name="setting_company_name" 
                                   value="{{ settings.general|selectattr('key', 'equalto', 'company_name')|map(attribute='value')|first or '' }}"
                                   placeholder="Your Company Name">
                            <small class="text-muted">Company name for branding</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="support_email" class="form-label">Support Email</label>
                            <input type="email" class="form-control" name="setting_support_email" 
                                   value="{{ settings.general|selectattr('key', 'equalto', 'support_email')|map(attribute='value')|first or '' }}"
                                   placeholder="support@yourcompany.com">
                            <small class="text-muted">Email for support inquiries</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="max_file_size_mb" class="form-label">Max File Size (MB)</label>
                            <input type="number" class="form-control" name="setting_max_file_size_mb" 
                                   value="{{ settings.general|selectattr('key', 'equalto', 'max_file_size_mb')|map(attribute='value')|first or '16' }}"
                                   placeholder="16" min="1" max="100">
                            <small class="text-muted">Maximum file upload size for CVs</small>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="setting_auto_notifications" 
                                       value="true" {% if settings.general|selectattr('key', 'equalto', 'auto_notifications')|map(attribute='value')|first == 'true' %}checked{% endif %}>
                                <label class="form-check-label">
                                    Enable automatic notifications
                                </label>
                            </div>
                            <small class="text-muted">Send notifications when application status changes</small>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> After updating settings, test each communication channel to ensure they're working properly.
                        </div>
                        
                        <!-- WhatsApp Bot Testing -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fab fa-whatsapp me-2"></i>Test WhatsApp Bot</h6>
                            </div>
                            <div class="card-body">
                                <form action="{{ url_for('test_whatsapp_bot') }}" method="POST" class="d-inline">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" name="from_number" 
                                                   value="+1234567890" placeholder="Test phone number">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" name="message_text" 
                                                   value="APPLY HLEB0H PXEI8387" placeholder="Test message">
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-success btn-sm mt-2">
                                        <i class="fas fa-robot me-1"></i>Test Bot Response
                                    </button>
                                </form>
                                <small class="text-muted d-block mt-1">
                                    This simulates a WhatsApp message to test the bot logic without needing actual WhatsApp API connection.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="d-flex gap-2 mb-4">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Save Settings
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-times me-1"></i>Cancel
            </a>
        </div>
    </form>
</div>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResultContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function testCommunication(channel) {
    // Show loading state
    const testBtn = event.target;
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Testing...';
    testBtn.disabled = true;
    
    fetch(`/settings/test/${channel}`)
        .then(response => response.json())
        .then(data => {
            // Show results in modal
            const resultContent = document.getElementById('testResultContent');
            const alertClass = data.success ? 'alert-success' : 'alert-danger';
            const icon = data.success ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            resultContent.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="${icon} me-2"></i>
                    ${data.message}
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            const resultContent = document.getElementById('testResultContent');
            resultContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Test failed: ${error.message}
                </div>
            `;
            new bootstrap.Modal(document.getElementById('testResultModal')).show();
        })
        .finally(() => {
            // Restore button state
            testBtn.innerHTML = originalText;
            testBtn.disabled = false;
        });
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        // Basic validation
        const requiredFields = form.querySelectorAll('input[required]');
        let valid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                valid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!valid) {
            e.preventDefault();
            showNotification('Please fill in all required fields', 'danger');
        }
    });
});
</script>
{% endblock %}